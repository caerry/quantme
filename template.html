<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>QuantMe Activity Report</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
                background-color: #f4f4f4;
            }
            .chart-container {
                background-color: #fff;
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            h1,
            h2 {
                color: #333;
            }
            canvas {
                max-width: 100%;
                height: auto;
            }
        </style>
    </head>
    <body>
        <h1>QuantMe Activity Report</h1>
        <p>Report generated on: {{ .GeneratedAt }}</p>
        <p>Data range: {{ .StartDate }} to {{ .EndDate }}</p>

        <div class="chart-container">
            <h2>Time Spent per Application</h2>
            <canvas id="appTimeChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Activity Timeline</h2>
            <p>
                (Note: Timeline shows Focus Changes, Pomodoro States, and Custom
                Events)
            </p>
            <canvas id="timelineChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Pomodoro Cycles Completed</h2>
            <p>Total Focus Cycles: {{ .TotalPomodoroCycles }}</p>
            <!-- Add more Pomodoro stats if needed -->
        </div>

        <div class="chart-container">
            <h2>Custom Event Frequency</h2>
            <canvas id="customEventChart"></canvas>
        </div>

        <script>
            // Data embedded from Go template
            const appTimeData = {{ .AppTimeJSON }};
            const timelineDataRaw = {{ .TimelineJSON }};
            const customEventData = {{ .CustomEventsJSON }};

            // --- Application Time Chart (Pie Chart) ---
            const ctxAppTime = document.getElementById('appTimeChart').getContext('2d');
            new Chart(ctxAppTime, {
                type: 'pie',
                data: {
                    labels: appTimeData.labels,
                    datasets: [{
                        label: 'Time Spent (minutes)',
                        data: appTimeData.values,
                        backgroundColor: [ // Add more colors if needed
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)',
                            'rgba(100, 255, 100, 0.8)',
                        ],
                        borderColor: 'rgba(255, 255, 255, 0.7)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed.toFixed(2) + ' minutes';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // --- Timeline Chart (Scatter/Bubble Chart) ---
            const ctxTimeline = document.getElementById('timelineChart').getContext('2d');
            // Map event types to numerical values for Y-axis and colors/shapes
            const eventTypeMap = {
                'focus_change': { y: 1, color: 'rgba(54, 162, 235, 0.7)', label: 'Focus' },
                'pomodoro_state': { y: 2, color: 'rgba(255, 99, 132, 0.7)', label: 'Pomodoro' },
                'custom': { y: 3, color: 'rgba(75, 192, 192, 0.7)', label: 'Custom' },
                'app_start': { y: 4, color: 'rgba(153, 102, 255, 0.7)', label: 'Start' },
                'app_stop': { y: 4, color: 'rgba(153, 102, 255, 0.7)', label: 'Stop' },
            };

            const timelineDataset = timelineDataRaw.map(event => {
                const mapping = eventTypeMap[event.type] || { y: 0, color: 'grey', label: event.type };
                let tooltipLabel = `${mapping.label}: `;
                if (event.type === 'focus_change') tooltipLabel += event.app;
                else if (event.type === 'pomodoro_state') tooltipLabel += event.tag;
                else if (event.type === 'custom') tooltipLabel += event.tag;
                else tooltipLabel += event.type;
                if(event.notes) tooltipLabel += ` (${event.notes})`;

                return {
                    x: event.ts, // Timestamp string should be parsed by adapter
                    y: mapping.y,
                    r: 5, // Radius of bubble
                    backgroundColor: mapping.color,
                    tooltipLabel: tooltipLabel,
                };
            });

            new Chart(ctxTimeline, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Activities',
                        data: timelineDataset,
                        // backgroundColor is set per point above
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour', // Adjust based on range
                                 tooltipFormat: 'PPpp', // Requires date-fns
                                 displayFormats: {
                                     hour: 'MMM d, HH:mm'
                                 }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            min: 0,
                            max: 5, // Adjust based on number of event types + 1
                            ticks: {
                                stepSize: 1,
                                callback: function(value, index, values) {
                                    // Find label based on value
                                    for (const key in eventTypeMap) {
                                        if (eventTypeMap[key].y === value) {
                                            return eventTypeMap[key].label;
                                        }
                                    }
                                    return ''; // Or return value if no label found
                                }
                            },
                            title: {
                                display: true,
                                text: 'Activity Type'
                            }
                        }
                    },
                    plugins: {
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Access the custom label stored in the data point
                                     return context.raw.tooltipLabel || 'Event';
                                }
                            }
                        },
                        legend: {
                             display: false // Hiding legend as colors/Y explain type
                        }
                    }
                }
            });


            // --- Custom Event Chart (Bar Chart) ---
            const ctxCustomEvent = document.getElementById('customEventChart').getContext('2d');
            new Chart(ctxCustomEvent, {
                type: 'bar',
                data: {
                    labels: customEventData.labels,
                    datasets: [{
                        label: 'Count',
                        data: customEventData.values,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                     indexAxis: 'y', // Makes it a horizontal bar chart
                    scales: {
                         x: {
                             beginAtZero: true,
                             ticks: { stepSize: 1 } // Ensure integer ticks for counts
                         }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        </script>
    </body>
</html>
